name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ffmpeg and jq
        run: sudo apt-get update && sudo apt-get install -y ffmpeg jq

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install jsonschema

      - name: Unit tests
        run: python -m unittest discover -v -s tests/unit -p "test_*.py"

      - name: Integration tests
        run: python -m unittest discover -v -s tests/integration -p "test_*.py"

      - name: Smoke G1->G8 and schema validate
        run: |
          mkdir -p ci_smoke/data ci_smoke/artifacts
          ffmpeg -y -f lavfi -i "testsrc=size=320x240:rate=24:duration=8" -f lavfi -i "sine=frequency=440:sample_rate=48000:duration=8" -c:v libx264 -pix_fmt yuv420p -c:a aac -shortest ci_smoke/data/raw_video.mp4
          python - <<'PY'
          import json
          from pathlib import Path
          base = Path("ci_smoke/data")
          (base / "audio_transcripts.json").write_text(json.dumps([
              {"start": "00:00:00.000", "end": "00:00:02.000", "text": "mo dau"},
              {"start": "00:00:02.000", "end": "00:00:04.000", "text": "dien bien"},
              {"start": "00:00:04.000", "end": "00:00:06.000", "text": "ket thuc"}
          ], ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          (base / "visual_captions.json").write_text(json.dumps([
              {"timestamp": "00:00:00.500", "caption": "canh 1"},
              {"timestamp": "00:00:02.500", "caption": "canh 2"},
              {"timestamp": "00:00:04.500", "caption": "canh 3"}
          ], ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          PY

          python -m reasoning_nlp.cli --audio-transcripts ci_smoke/data/audio_transcripts.json --visual-captions ci_smoke/data/visual_captions.json --raw-video ci_smoke/data/raw_video.mp4 --stage g8 --run-id ci_smoke --artifacts-root ci_smoke/artifacts --summarize-backend api --summarize-fallback-backend api

          python docs/Reasoning-NLP/schema/validate_artifacts.py --alignment ci_smoke/artifacts/ci_smoke/g2_align/alignment_result.json --script ci_smoke/artifacts/ci_smoke/g5_segment/summary_script.json --manifest ci_smoke/artifacts/ci_smoke/g5_segment/summary_video_manifest.json --report ci_smoke/artifacts/ci_smoke/g8_qc/quality_report.json --contracts-dir contracts/v1/template --enforce-thresholds
